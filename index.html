<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†è²¨å¹£å›æ¸¬æ¡†æ¶</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a26;
            --accent-gold: #f0b90b;
            --accent-gold-dim: rgba(240, 185, 11, 0.15);
            --profit: #00d4aa;
            --loss: #ff4757;
            --text-primary: #ffffff;
            --text-secondary: #8a8a9a;
            --border: #2a2a3a;
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 20% 20%, rgba(240, 185, 11, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 212, 170, 0.02) 0%, transparent 50%);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-gold), #ff9500);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo h1 {
            font-size: 1.8em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-gold), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo span {
            font-size: 0.75em;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }
        
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
        }
        
        .panel-title {
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent-gold);
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        select, input {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95em;
            transition: all 0.2s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px var(--accent-gold-dim);
        }
        
        .strategy-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .strategy-card:hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }
        
        .strategy-card.active {
            border-color: var(--accent-gold);
            background: var(--accent-gold-dim);
        }
        
        .strategy-card h4 {
            font-size: 1em;
            margin-bottom: 5px;
        }
        
        .strategy-card p {
            font-size: 0.8em;
            color: var(--text-secondary);
        }
        
        .strategy-params {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        
        .strategy-card.active .strategy-params {
            display: block;
        }
        
        .strategy-category {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--accent-gold);
            margin: 20px 0 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .strategy-category:first-of-type {
            margin-top: 0;
        }
        
        .param-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .param-row input {
            flex: 1;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-gold), #ff9500);
            color: #000;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(240, 185, 11, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .results-area {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-card .label {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5em;
            font-weight: 700;
        }
        
        .stat-card .value.profit { color: var(--profit); }
        .stat-card .value.loss { color: var(--loss); }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        .trades-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
        }
        
        .trades-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.8em;
        }
        
        .trades-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .trades-table tr:hover {
            background: var(--bg-tertiary);
        }
        
        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .tag.buy {
            background: rgba(0, 212, 170, 0.15);
            color: var(--profit);
        }
        
        .tag.sell {
            background: rgba(255, 71, 87, 0.15);
            color: var(--loss);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 60px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--profit));
            width: 0%;
            transition: width 0.3s;
        }
        
        .hidden { display: none !important; }
        
        .table-scroll {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-scroll::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-scroll::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gold);
        }
        
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">âš¡</div>
                <div>
                    <h1>CryptoBacktest</h1>
                    <span>v1.0 | Binance USDT Market</span>
                </div>
            </div>
        </header>
        
        <div class="main-grid">
            <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <div class="panel">
                    <div class="panel-title">ğŸ“Š å¸‚å ´è¨­å®š</div>
                    
                    <div class="form-group">
                        <label>äº¤æ˜“å°</label>
                        <select id="symbol">
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="BNBUSDT">BNB/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                            <option value="SOLUSDT">SOL/USDT</option>
                            <option value="XRPUSDT">XRP/USDT</option>
                            <option value="DOGEUSDT">DOGE/USDT</option>
                            <option value="DOTUSDT">DOT/USDT</option>
                            <option value="AVAXUSDT">AVAX/USDT</option>
                            <option value="MATICUSDT">MATIC/USDT</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Kç·šé€±æœŸ</label>
                        <select id="interval">
                            <option value="1h">1 å°æ™‚</option>
                            <option value="4h" selected>4 å°æ™‚</option>
                            <option value="1d">1 å¤©</option>
                            <option value="1w">1 é€±</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å›æ¸¬èµ·å§‹æ™‚é–“</label>
                        <select id="startTime">
                            <option value="30">æœ€è¿‘ 30 å¤©</option>
                            <option value="90">æœ€è¿‘ 90 å¤©</option>
                            <option value="180">æœ€è¿‘ 180 å¤©</option>
                            <option value="365">æœ€è¿‘ 1 å¹´</option>
                            <option value="730">æœ€è¿‘ 2 å¹´</option>
                            <option value="1095">æœ€è¿‘ 3 å¹´</option>
                            <option value="1825">æœ€è¿‘ 5 å¹´</option>
                            <option value="2017" selected>å¾ 2017 å¹´é–‹å§‹</option>
                            <option value="2018">å¾ 2018 å¹´é–‹å§‹</option>
                            <option value="2019">å¾ 2019 å¹´é–‹å§‹</option>
                            <option value="2020">å¾ 2020 å¹´é–‹å§‹</option>
                            <option value="2021">å¾ 2021 å¹´é–‹å§‹</option>
                            <option value="2022">å¾ 2022 å¹´é–‹å§‹</option>
                            <option value="2023">å¾ 2023 å¹´é–‹å§‹</option>
                            <option value="2024">å¾ 2024 å¹´é–‹å§‹</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>åˆå§‹è³‡é‡‘ (USDT)</label>
                        <input type="number" id="capital" value="10000" min="100">
                    </div>
                    
                    <div class="form-group">
                        <label>æ‰‹çºŒè²»ç‡ (%)</label>
                        <input type="number" id="fee" value="0.1" min="0" max="1" step="0.01">
                    </div>
                </div>
                
                <div class="panel" style="margin-top: 20px; max-height: 600px; overflow-y: auto;">
                    <div class="panel-title">ğŸ¯ é¸æ“‡ç­–ç•¥</div>
                    
                    <div class="strategy-category">ğŸ“ˆ è¶¨å‹¢è·Ÿéš¨ç­–ç•¥</div>
                    
                    <div class="strategy-card active" data-strategy="sma_cross">
                        <h4>SMA å‡ç·šäº¤å‰</h4>
                        <p>çŸ­æœŸå‡ç·šä¸Šç©¿é•·æœŸå‡ç·šè²·å…¥ï¼Œä¸‹ç©¿è³£å‡º</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="sma_short" value="10" min="2" placeholder="çŸ­æœŸ">
                                <input type="number" id="sma_long" value="30" min="5" placeholder="é•·æœŸ">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="ema_cross">
                        <h4>EMA å‡ç·šäº¤å‰</h4>
                        <p>ä½¿ç”¨æŒ‡æ•¸ç§»å‹•å¹³å‡ç·šï¼Œå°è¿‘æœŸåƒ¹æ ¼æ›´æ•æ„Ÿ</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="ema_short" value="12" min="2" placeholder="çŸ­æœŸ">
                                <input type="number" id="ema_long" value="26" min="5" placeholder="é•·æœŸ">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="macd">
                        <h4>MACD äº¤å‰</h4>
                        <p>MACD ç·šä¸Šç©¿ä¿¡è™Ÿç·šè²·å…¥ï¼Œä¸‹ç©¿è³£å‡º</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="macd_fast" value="12" min="2" placeholder="å¿«ç·š">
                                <input type="number" id="macd_slow" value="26" min="5" placeholder="æ…¢ç·š">
                            </div>
                            <div class="param-row">
                                <input type="number" id="macd_signal" value="9" min="2" placeholder="ä¿¡è™Ÿç·š">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="adx_trend">
                        <h4>ADX è¶¨å‹¢å¼·åº¦</h4>
                        <p>ADX ç¢ºèªè¶¨å‹¢å¼·åº¦ + DMI åˆ¤æ–·æ–¹å‘</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="adx_period" value="14" min="5" placeholder="ADXé€±æœŸ">
                                <input type="number" id="adx_threshold" value="25" min="15" max="40" placeholder="è¶¨å‹¢é–¾å€¼">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-category">ğŸ“Š éœ‡ç›ªæŒ‡æ¨™ç­–ç•¥</div>
                    
                    <div class="strategy-card" data-strategy="rsi">
                        <h4>RSI è¶…è²·è¶…è³£</h4>
                        <p>RSI ä½æ–¼é–¾å€¼è²·å…¥ï¼Œé«˜æ–¼é–¾å€¼è³£å‡º</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="rsi_period" value="14" min="2" placeholder="é€±æœŸ">
                            </div>
                            <div class="param-row">
                                <input type="number" id="rsi_oversold" value="30" min="10" max="50" placeholder="è¶…è³£">
                                <input type="number" id="rsi_overbought" value="70" min="50" max="90" placeholder="è¶…è²·">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="bollinger">
                        <h4>å¸ƒæ—é€šé“</h4>
                        <p>åƒ¹æ ¼è§¸åŠä¸‹è»Œè²·å…¥ï¼Œè§¸åŠä¸Šè»Œè³£å‡º</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="bb_period" value="20" min="5" placeholder="é€±æœŸ">
                                <input type="number" id="bb_std" value="2" min="1" max="4" step="0.5" placeholder="æ¨™æº–å·®">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-category">ğŸ’¹ åƒ¹é‡è¤‡åˆç­–ç•¥</div>
                    
                    <div class="strategy-card" data-strategy="vwap">
                        <h4>VWAP çªç ´</h4>
                        <p>åƒ¹æ ¼çªç ´ VWAP è²·å…¥ï¼Œè·Œç ´è³£å‡ºï¼ˆæ—¥å…§æŒ‡æ¨™ï¼‰</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="vwap_period" value="20" min="5" placeholder="è¨ˆç®—é€±æœŸ">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="mfi">
                        <h4>MFI è³‡é‡‘æµé‡</h4>
                        <p>çµåˆåƒ¹é‡çš„ RSIï¼Œè¡¡é‡è²·è³£å£“åŠ›</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="mfi_period" value="14" min="2" placeholder="é€±æœŸ">
                            </div>
                            <div class="param-row">
                                <input type="number" id="mfi_oversold" value="20" min="10" max="40" placeholder="è¶…è³£">
                                <input type="number" id="mfi_overbought" value="80" min="60" max="90" placeholder="è¶…è²·">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="obv">
                        <h4>OBV èƒ½é‡æ½®</h4>
                        <p>è¿½è¹¤ç´¯ç©æ·¨æˆäº¤é‡ï¼ŒOBV å‡ç·šäº¤å‰</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="obv_short" value="10" min="2" placeholder="çŸ­æœŸå‡ç·š">
                                <input type="number" id="obv_long" value="30" min="5" placeholder="é•·æœŸå‡ç·š">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="ad_line">
                        <h4>AD ç´¯ç©æ´¾ç™¼ç·š</h4>
                        <p>è³‡é‡‘æµå…¥æµå‡ºè¶¨å‹¢ï¼Œæ­é…åƒ¹æ ¼èƒŒé›¢</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="ad_short" value="10" min="2" placeholder="çŸ­æœŸå‡ç·š">
                                <input type="number" id="ad_long" value="30" min="5" placeholder="é•·æœŸå‡ç·š">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-category">ğŸ”„ èƒŒé›¢ç­–ç•¥</div>
                    
                    <div class="strategy-card" data-strategy="rsi_divergence">
                        <h4>RSI èƒŒé›¢</h4>
                        <p>åƒ¹æ ¼èˆ‡ RSI èƒŒé›¢æ™‚åè½‰äº¤æ˜“</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="rsi_div_period" value="14" min="5" placeholder="RSIé€±æœŸ">
                                <input type="number" id="rsi_div_lookback" value="20" min="10" placeholder="å›çœ‹é€±æœŸ">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="obv_divergence">
                        <h4>OBV èƒŒé›¢</h4>
                        <p>åƒ¹æ ¼èˆ‡æˆäº¤é‡èƒŒé›¢ï¼Œè³‡é‡‘å…ˆè¡ŒæŒ‡æ¨™</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="obv_div_lookback" value="20" min="10" placeholder="å›çœ‹é€±æœŸ">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="mfi_divergence">
                        <h4>MFI èƒŒé›¢</h4>
                        <p>è³‡é‡‘æµé‡èˆ‡åƒ¹æ ¼èƒŒé›¢ï¼Œé«˜å¯é åº¦åè½‰è¨Šè™Ÿ</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="mfi_div_period" value="14" min="5" placeholder="MFIé€±æœŸ">
                                <input type="number" id="mfi_div_lookback" value="20" min="10" placeholder="å›çœ‹é€±æœŸ">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-category">ğŸ”€ è¤‡åˆç­–ç•¥</div>
                    
                    <div class="strategy-card" data-strategy="macd_rsi_combo">
                        <h4>MACD + RSI è¤‡åˆ</h4>
                        <p>MACD ç¢ºèªè¶¨å‹¢ + RSI éæ¿¾æ¥µå€¼</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="combo_rsi_period" value="14" min="5" placeholder="RSIé€±æœŸ">
                            </div>
                            <div class="param-row">
                                <input type="number" id="combo_rsi_low" value="40" min="20" max="50" placeholder="RSIä½">
                                <input type="number" id="combo_rsi_high" value="60" min="50" max="80" placeholder="RSIé«˜">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="triple_screen">
                        <h4>ä¸‰é‡æ¿¾ç¶²ç³»çµ±</h4>
                        <p>é•·æœŸè¶¨å‹¢(MACD) + ä¸­æœŸéœ‡ç›ª(RSI) + çŸ­æœŸå…¥å ´</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="ts_rsi_period" value="14" min="5" placeholder="RSIé€±æœŸ">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="vwap_mfi_combo">
                        <h4>VWAP + MFI è¤‡åˆ</h4>
                        <p>VWAP ç¢ºèªè¶¨å‹¢ + MFI ç¢ºèªè³‡é‡‘æµå‘</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="vwap_mfi_period" value="14" min="5" placeholder="MFIé€±æœŸ">
                            </div>
                            <div class="param-row">
                                <input type="number" id="vwap_mfi_threshold" value="50" min="40" max="60" placeholder="MFIä¸­è»¸">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-category">ğŸ’° å®šæŠ•ç­–ç•¥</div>
                    
                    <div class="strategy-card" data-strategy="dca">
                        <h4>å®šæœŸå®šé¡ (DCA)</h4>
                        <p>æ¯éš”å›ºå®šé€±æœŸæŠ•å…¥å›ºå®šé‡‘é¡</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="dca_interval" value="7" min="1" placeholder="é–“éš”(å¤©)">
                                <input type="number" id="dca_amount" value="500" min="10" placeholder="æ¯æ¬¡é‡‘é¡">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="smart_dca">
                        <h4>æ™ºèƒ½ DCA</h4>
                        <p>RSI ä½æ™‚åŠ å€è²·å…¥ï¼Œé«˜æ™‚æ¸›åŠ</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="sdca_interval" value="7" min="1" placeholder="é–“éš”(å¤©)">
                                <input type="number" id="sdca_base" value="500" min="10" placeholder="åŸºç¤é‡‘é¡">
                            </div>
                            <div class="param-row">
                                <input type="number" id="sdca_rsi_low" value="30" min="10" max="40" placeholder="RSIä½">
                                <input type="number" id="sdca_rsi_high" value="70" min="60" max="90" placeholder="RSIé«˜">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-category">ğŸ“ Kç·šä¸‰è§’å½¢æ…‹ç­–ç•¥</div>
                    
                    <div class="strategy-card" data-strategy="sym_triangle">
                        <h4>å°ç¨±ä¸‰è§’å½¢çªç ´</h4>
                        <p>ä¸­ç«‹å½¢æ…‹ï¼Œè·Ÿéš¨çªç ´æ–¹å‘äº¤æ˜“</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="sym_lookback" value="30" min="15" max="60" placeholder="å›çœ‹é€±æœŸ">
                                <input type="number" id="sym_touches" value="2" min="2" max="5" placeholder="æœ€å°‘è§¸é»">
                            </div>
                            <div class="param-row">
                                <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                                    <input type="checkbox" id="sym_vol_confirm" checked> æˆäº¤é‡ç¢ºèª
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="asc_triangle">
                        <h4>ä¸Šå‡ä¸‰è§’å½¢çªç ´</h4>
                        <p>çœ‹æ¼²å½¢æ…‹ï¼Œé«˜æ¦‚ç‡å‘ä¸Šçªç ´</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="asc_lookback" value="30" min="15" max="60" placeholder="å›çœ‹é€±æœŸ">
                                <input type="number" id="asc_touches" value="2" min="2" max="5" placeholder="æœ€å°‘è§¸é»">
                            </div>
                            <div class="param-row">
                                <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                                    <input type="checkbox" id="asc_vol_confirm" checked> æˆäº¤é‡ç¢ºèª
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="desc_triangle">
                        <h4>ä¸‹é™ä¸‰è§’å½¢çªç ´</h4>
                        <p>çœ‹è·Œå½¢æ…‹ï¼Œé«˜æ¦‚ç‡å‘ä¸‹çªç ´</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="desc_lookback" value="30" min="15" max="60" placeholder="å›çœ‹é€±æœŸ">
                                <input type="number" id="desc_touches" value="2" min="2" max="5" placeholder="æœ€å°‘è§¸é»">
                            </div>
                            <div class="param-row">
                                <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                                    <input type="checkbox" id="desc_vol_confirm" checked> æˆäº¤é‡ç¢ºèª
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="all_triangles">
                        <h4>ç¶œåˆä¸‰è§’å½¢ç­–ç•¥</h4>
                        <p>è­˜åˆ¥æ‰€æœ‰ä¸‰è§’å½¢æ…‹ä¸¦äº¤æ˜“</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="all_lookback" value="30" min="15" max="60" placeholder="å›çœ‹é€±æœŸ">
                                <input type="number" id="all_touches" value="2" min="2" max="5" placeholder="æœ€å°‘è§¸é»">
                            </div>
                            <div class="param-row">
                                <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                                    <input type="checkbox" id="all_vol_confirm" checked> æˆäº¤é‡ç¢ºèª
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-category">ğŸ“+ ä¸‰è§’å½¢æ…‹å¤šé‡ç¢ºèªç­–ç•¥</div>
                    
                    <div class="strategy-card" data-strategy="triangle_rsi">
                        <h4>ä¸‰è§’å½¢ + RSI ç¢ºèª</h4>
                        <p>çªç ´ + RSI æ–¹å‘ç¢ºèªï¼Œæ¸›å°‘å‡çªç ´</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="tri_rsi_lookback" value="30" min="15" max="60" placeholder="å›çœ‹é€±æœŸ">
                                <input type="number" id="tri_rsi_touches" value="2" min="2" max="5" placeholder="æœ€å°‘è§¸é»">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="triangle_macd">
                        <h4>ä¸‰è§’å½¢ + MACD ç¢ºèª</h4>
                        <p>çªç ´ + MACD å‹•èƒ½ç¢ºèª</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="tri_macd_lookback" value="30" min="15" max="60" placeholder="å›çœ‹é€±æœŸ">
                                <input type="number" id="tri_macd_touches" value="2" min="2" max="5" placeholder="æœ€å°‘è§¸é»">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-card" data-strategy="triangle_multi">
                        <h4>ä¸‰è§’å½¢å¤šé‡ç¢ºèªï¼ˆæ¨è–¦ï¼‰</h4>
                        <p>çªç ´ + æˆäº¤é‡ + RSI + MACD å››é‡ç¢ºèª</p>
                        <div class="strategy-params">
                            <div class="param-row">
                                <input type="number" id="tri_multi_lookback" value="30" min="15" max="60" placeholder="å›çœ‹é€±æœŸ">
                                <input type="number" id="tri_multi_touches" value="2" min="2" max="5" placeholder="æœ€å°‘è§¸é»">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="runBacktest" style="margin-top: 20px;">
                        ğŸš€ é–‹å§‹å›æ¸¬
                    </button>
                    
                    <div class="progress-bar" id="progressBar">
                        <div class="fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
            
            <!-- å³å´çµæœå€ -->
            <div class="results-area">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loadingText">æ­£åœ¨è¼‰å…¥æ•¸æ“šä¸¦åŸ·è¡Œå›æ¸¬...</p>
                </div>
                
                <div id="resultsContainer" class="hidden">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="label">å›æ¸¬æœŸé–“</div>
                            <div class="value" id="backtestPeriod" style="font-size: 1em;">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">K ç·šæ•¸é‡</div>
                            <div class="value" id="totalBars">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">ç¸½å ±é…¬</div>
                            <div class="value" id="totalReturn">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">å¹´åŒ–å ±é…¬</div>
                            <div class="value" id="annualReturn">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">æœ€å¤§å›æ’¤</div>
                            <div class="value" id="maxDrawdown">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">å¤æ™®æ¯”ç‡</div>
                            <div class="value" id="sharpeRatio">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">å‹ç‡</div>
                            <div class="value" id="winRate">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">ç¸½äº¤æ˜“æ¬¡æ•¸</div>
                            <div class="value" id="totalTrades">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">ç›ˆè™§æ¯”</div>
                            <div class="value" id="profitFactor">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">æœ€çµ‚è³‡ç”¢</div>
                            <div class="value" id="finalEquity">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">è²·å…¥æŒæœ‰å ±é…¬</div>
                            <div class="value" id="buyHoldReturn">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">ç­–ç•¥ vs æŒæœ‰</div>
                            <div class="value" id="strategyVsHold">-</div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-title">ğŸ“ˆ æ¬Šç›Šæ›²ç·š</div>
                        <div class="chart-container">
                            <canvas id="equityChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-title">ğŸ“‹ äº¤æ˜“ç´€éŒ„</div>
                        <div class="table-scroll">
                            <table class="trades-table">
                                <thead>
                                    <tr>
                                        <th>æ™‚é–“</th>
                                        <th>é¡å‹</th>
                                        <th>åƒ¹æ ¼</th>
                                        <th>æ•¸é‡</th>
                                        <th>ç›ˆè™§</th>
                                        <th>è³‡ç”¢</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="panel" id="welcomePanel">
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“Š</div>
                        <h2 style="margin-bottom: 15px;">é¸æ“‡ç­–ç•¥é–‹å§‹å›æ¸¬</h2>
                        <p style="color: var(--text-secondary); max-width: 400px; margin: 0 auto;">
                            å¾å·¦å´é¸æ“‡äº¤æ˜“å°ã€è¨­å®šåƒæ•¸ä¸¦é¸æ“‡ä¸€ç¨®ç­–ç•¥ï¼Œ<br>
                            ç„¶å¾Œé»æ“Šã€Œé–‹å§‹å›æ¸¬ã€æŸ¥çœ‹æ­·å²è¡¨ç¾ã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== æŠ€è¡“æŒ‡æ¨™è¨ˆç®— ====================
        
        // ç°¡å–®ç§»å‹•å¹³å‡ç·š
        function SMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    result.push(sum / period);
                }
            }
            return result;
        }
        
        // æŒ‡æ•¸ç§»å‹•å¹³å‡ç·š
        function EMA(data, period) {
            const result = [];
            const multiplier = 2 / (period + 1);
            
            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += data[i];
                result.push(null);
            }
            result[period - 1] = sum / period;
            
            for (let i = period; i < data.length; i++) {
                const ema = (data[i] - result[i - 1]) * multiplier + result[i - 1];
                result.push(ema);
            }
            return result;
        }
        
        // ç›¸å°å¼·å¼±æŒ‡æ¨™
        function RSI(data, period) {
            const result = [];
            const gains = [];
            const losses = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    result.push(null);
                    continue;
                }
                
                const change = data[i] - data[i - 1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? -change : 0);
                
                if (i < period) {
                    result.push(null);
                    continue;
                }
                
                const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
                const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;
                
                if (avgLoss === 0) {
                    result.push(100);
                } else {
                    const rs = avgGain / avgLoss;
                    result.push(100 - (100 / (1 + rs)));
                }
            }
            return result;
        }
        
        // MACD æŒ‡æ¨™
        function MACD(data, fastPeriod, slowPeriod, signalPeriod) {
            const fastEMA = EMA(data, fastPeriod);
            const slowEMA = EMA(data, slowPeriod);
            
            const macdLine = [];
            for (let i = 0; i < data.length; i++) {
                if (fastEMA[i] === null || slowEMA[i] === null) {
                    macdLine.push(null);
                } else {
                    macdLine.push(fastEMA[i] - slowEMA[i]);
                }
            }
            
            const validMacd = macdLine.filter(v => v !== null);
            const signalEMA = EMA(validMacd, signalPeriod);
            
            const signalLine = [];
            let signalIdx = 0;
            for (let i = 0; i < data.length; i++) {
                if (macdLine[i] === null) {
                    signalLine.push(null);
                } else {
                    signalLine.push(signalEMA[signalIdx] || null);
                    signalIdx++;
                }
            }
            
            // è¨ˆç®—æŸ±ç‹€åœ–
            const histogram = [];
            for (let i = 0; i < data.length; i++) {
                if (macdLine[i] === null || signalLine[i] === null) {
                    histogram.push(null);
                } else {
                    histogram.push(macdLine[i] - signalLine[i]);
                }
            }
            
            return { macdLine, signalLine, histogram };
        }
        
        // å¸ƒæ—é€šé“
        function BollingerBands(data, period, stdDev) {
            const sma = SMA(data, period);
            const upper = [];
            const lower = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    upper.push(null);
                    lower.push(null);
                } else {
                    const slice = data.slice(i - period + 1, i + 1);
                    const mean = sma[i];
                    const variance = slice.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / period;
                    const std = Math.sqrt(variance);
                    upper.push(mean + stdDev * std);
                    lower.push(mean - stdDev * std);
                }
            }
            
            return { middle: sma, upper, lower };
        }
        
        // ==================== åƒ¹é‡è¤‡åˆå‹æŒ‡æ¨™ ====================
        
        // VWAP - æˆäº¤é‡åŠ æ¬Šå¹³å‡åƒ¹
        function VWAP(candles, period) {
            const result = [];
            
            for (let i = 0; i < candles.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                    continue;
                }
                
                let sumPV = 0;  // åƒ¹æ ¼ * æˆäº¤é‡
                let sumV = 0;   // æˆäº¤é‡
                
                for (let j = i - period + 1; j <= i; j++) {
                    // å…¸å‹åƒ¹æ ¼ = (é«˜ + ä½ + æ”¶) / 3
                    const tp = (candles[j].high + candles[j].low + candles[j].close) / 3;
                    sumPV += tp * candles[j].volume;
                    sumV += candles[j].volume;
                }
                
                result.push(sumV > 0 ? sumPV / sumV : null);
            }
            
            return result;
        }
        
        // MFI - è³‡é‡‘æµé‡æŒ‡æ¨™ (çµåˆåƒ¹é‡çš„ RSI)
        function MFI(candles, period) {
            const result = [];
            const typicalPrices = [];
            const rawMoneyFlows = [];
            
            for (let i = 0; i < candles.length; i++) {
                // å…¸å‹åƒ¹æ ¼
                const tp = (candles[i].high + candles[i].low + candles[i].close) / 3;
                typicalPrices.push(tp);
                
                // åŸå§‹è³‡é‡‘æµé‡ = å…¸å‹åƒ¹æ ¼ * æˆäº¤é‡
                const rmf = tp * candles[i].volume;
                
                if (i === 0) {
                    rawMoneyFlows.push({ positive: 0, negative: 0 });
                    result.push(null);
                    continue;
                }
                
                // åˆ¤æ–·è³‡é‡‘æµå‘
                if (tp > typicalPrices[i - 1]) {
                    rawMoneyFlows.push({ positive: rmf, negative: 0 });
                } else if (tp < typicalPrices[i - 1]) {
                    rawMoneyFlows.push({ positive: 0, negative: rmf });
                } else {
                    rawMoneyFlows.push({ positive: 0, negative: 0 });
                }
                
                if (i < period) {
                    result.push(null);
                    continue;
                }
                
                // è¨ˆç®—æ­£è² è³‡é‡‘æµé‡ç¸½å’Œ
                let positiveFlow = 0;
                let negativeFlow = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    positiveFlow += rawMoneyFlows[j].positive;
                    negativeFlow += rawMoneyFlows[j].negative;
                }
                
                // è³‡é‡‘æµé‡æ¯”ç‡å’Œ MFI
                if (negativeFlow === 0) {
                    result.push(100);
                } else {
                    const mfr = positiveFlow / negativeFlow;
                    result.push(100 - (100 / (1 + mfr)));
                }
            }
            
            return result;
        }
        
        // OBV - èƒ½é‡æ½®æŒ‡æ¨™
        function OBV(candles) {
            const result = [0];
            
            for (let i = 1; i < candles.length; i++) {
                if (candles[i].close > candles[i - 1].close) {
                    result.push(result[i - 1] + candles[i].volume);
                } else if (candles[i].close < candles[i - 1].close) {
                    result.push(result[i - 1] - candles[i].volume);
                } else {
                    result.push(result[i - 1]);
                }
            }
            
            return result;
        }
        
        // AD Line - ç´¯ç©/æ´¾ç™¼ç·š
        function ADLine(candles) {
            const result = [0];
            
            for (let i = 1; i < candles.length; i++) {
                const high = candles[i].high;
                const low = candles[i].low;
                const close = candles[i].close;
                const volume = candles[i].volume;
                
                // è³‡é‡‘æµé‡ä¹˜æ•¸ = ((æ”¶ç›¤åƒ¹ - æœ€ä½åƒ¹) - (æœ€é«˜åƒ¹ - æ”¶ç›¤åƒ¹)) / (æœ€é«˜åƒ¹ - æœ€ä½åƒ¹)
                let mfm = 0;
                if (high !== low) {
                    mfm = ((close - low) - (high - close)) / (high - low);
                }
                
                // è³‡é‡‘æµé‡æˆäº¤é‡ = ä¹˜æ•¸ * æˆäº¤é‡
                const mfv = mfm * volume;
                
                result.push(result[i - 1] + mfv);
            }
            
            return result;
        }
        
        // ATR - å¹³å‡çœŸå¯¦æ³¢å¹…
        function ATR(candles, period) {
            const result = [];
            const trueRanges = [];
            
            for (let i = 0; i < candles.length; i++) {
                if (i === 0) {
                    trueRanges.push(candles[i].high - candles[i].low);
                    result.push(null);
                    continue;
                }
                
                // çœŸå¯¦æ³¢å¹… = max(é«˜-ä½, |é«˜-å‰æ”¶|, |ä½-å‰æ”¶|)
                const tr = Math.max(
                    candles[i].high - candles[i].low,
                    Math.abs(candles[i].high - candles[i - 1].close),
                    Math.abs(candles[i].low - candles[i - 1].close)
                );
                trueRanges.push(tr);
                
                if (i < period) {
                    result.push(null);
                    continue;
                }
                
                const atr = trueRanges.slice(-period).reduce((a, b) => a + b, 0) / period;
                result.push(atr);
            }
            
            return result;
        }
        
        // ADX - å¹³å‡è¶¨å‘æŒ‡æ•¸
        function ADX(candles, period) {
            const result = { adx: [], pdi: [], mdi: [] };
            const trueRanges = [];
            const plusDMs = [];
            const minusDMs = [];
            
            for (let i = 0; i < candles.length; i++) {
                if (i === 0) {
                    trueRanges.push(candles[i].high - candles[i].low);
                    plusDMs.push(0);
                    minusDMs.push(0);
                    result.adx.push(null);
                    result.pdi.push(null);
                    result.mdi.push(null);
                    continue;
                }
                
                // True Range
                const tr = Math.max(
                    candles[i].high - candles[i].low,
                    Math.abs(candles[i].high - candles[i - 1].close),
                    Math.abs(candles[i].low - candles[i - 1].close)
                );
                trueRanges.push(tr);
                
                // Directional Movement
                const upMove = candles[i].high - candles[i - 1].high;
                const downMove = candles[i - 1].low - candles[i].low;
                
                plusDMs.push(upMove > downMove && upMove > 0 ? upMove : 0);
                minusDMs.push(downMove > upMove && downMove > 0 ? downMove : 0);
                
                if (i < period) {
                    result.adx.push(null);
                    result.pdi.push(null);
                    result.mdi.push(null);
                    continue;
                }
                
                // å¹³æ»‘è¨ˆç®—
                const smoothTR = trueRanges.slice(-period).reduce((a, b) => a + b, 0);
                const smoothPlusDM = plusDMs.slice(-period).reduce((a, b) => a + b, 0);
                const smoothMinusDM = minusDMs.slice(-period).reduce((a, b) => a + b, 0);
                
                // +DI å’Œ -DI
                const pdi = smoothTR > 0 ? (smoothPlusDM / smoothTR) * 100 : 0;
                const mdi = smoothTR > 0 ? (smoothMinusDM / smoothTR) * 100 : 0;
                
                result.pdi.push(pdi);
                result.mdi.push(mdi);
                
                // DX
                const dx = (pdi + mdi) > 0 ? Math.abs(pdi - mdi) / (pdi + mdi) * 100 : 0;
                
                // ADX (DX çš„å¹³æ»‘å¹³å‡)
                if (i < period * 2) {
                    result.adx.push(null);
                } else {
                    const recentDX = [];
                    for (let j = i - period + 1; j <= i; j++) {
                        const pdiJ = result.pdi[j] || 0;
                        const mdiJ = result.mdi[j] || 0;
                        recentDX.push((pdiJ + mdiJ) > 0 ? Math.abs(pdiJ - mdiJ) / (pdiJ + mdiJ) * 100 : 0);
                    }
                    result.adx.push(recentDX.reduce((a, b) => a + b, 0) / period);
                }
            }
            
            return result;
        }
        
        // èƒŒé›¢æª¢æ¸¬å‡½æ•¸
        function detectDivergence(prices, indicator, lookback) {
            const result = [];
            
            for (let i = 0; i < prices.length; i++) {
                if (i < lookback || indicator[i] === null) {
                    result.push(0);
                    continue;
                }
                
                // æ‰¾è¿‘æœŸåƒ¹æ ¼å’ŒæŒ‡æ¨™çš„é«˜ä½é»
                const priceSlice = prices.slice(i - lookback, i + 1);
                const indSlice = indicator.slice(i - lookback, i + 1).filter(v => v !== null);
                
                if (indSlice.length < lookback / 2) {
                    result.push(0);
                    continue;
                }
                
                const priceHigh = Math.max(...priceSlice);
                const priceLow = Math.min(...priceSlice);
                const indHigh = Math.max(...indSlice);
                const indLow = Math.min(...indSlice);
                
                const currentPrice = prices[i];
                const currentInd = indicator[i];
                
                // å¤šé ­èƒŒé›¢ï¼šåƒ¹æ ¼å‰µæ–°ä½ä½†æŒ‡æ¨™æœªå‰µæ–°ä½
                if (currentPrice <= priceLow * 1.01 && currentInd > indLow * 1.05) {
                    result.push(1); // è²·å…¥ä¿¡è™Ÿ
                }
                // ç©ºé ­èƒŒé›¢ï¼šåƒ¹æ ¼å‰µæ–°é«˜ä½†æŒ‡æ¨™æœªå‰µæ–°é«˜
                else if (currentPrice >= priceHigh * 0.99 && currentInd < indHigh * 0.95) {
                    result.push(-1); // è³£å‡ºä¿¡è™Ÿ
                }
                else {
                    result.push(0);
                }
            }
            
            return result;
        }
        
        // ==================== ç­–ç•¥å¯¦ç¾ ====================
        
        const strategies = {
            // === è¶¨å‹¢è·Ÿéš¨ç­–ç•¥ ===
            
            sma_cross: (candles, params) => {
                const closes = candles.map(c => c.close);
                const shortMA = SMA(closes, params.short);
                const longMA = SMA(closes, params.long);
                
                const signals = [];
                for (let i = 1; i < candles.length; i++) {
                    if (shortMA[i] === null || longMA[i] === null || 
                        shortMA[i-1] === null || longMA[i-1] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    if (shortMA[i-1] <= longMA[i-1] && shortMA[i] > longMA[i]) {
                        signals.push(1);
                    } else if (shortMA[i-1] >= longMA[i-1] && shortMA[i] < longMA[i]) {
                        signals.push(-1);
                    } else {
                        signals.push(0);
                    }
                }
                return [0, ...signals];
            },
            
            ema_cross: (candles, params) => {
                const closes = candles.map(c => c.close);
                const shortMA = EMA(closes, params.short);
                const longMA = EMA(closes, params.long);
                
                const signals = [];
                for (let i = 1; i < candles.length; i++) {
                    if (shortMA[i] === null || longMA[i] === null || 
                        shortMA[i-1] === null || longMA[i-1] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    if (shortMA[i-1] <= longMA[i-1] && shortMA[i] > longMA[i]) {
                        signals.push(1);
                    } else if (shortMA[i-1] >= longMA[i-1] && shortMA[i] < longMA[i]) {
                        signals.push(-1);
                    } else {
                        signals.push(0);
                    }
                }
                return [0, ...signals];
            },
            
            macd: (candles, params) => {
                const closes = candles.map(c => c.close);
                const { macdLine, signalLine } = MACD(closes, params.fast, params.slow, params.signal);
                
                const signals = [];
                for (let i = 1; i < candles.length; i++) {
                    if (macdLine[i] === null || signalLine[i] === null ||
                        macdLine[i-1] === null || signalLine[i-1] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    if (macdLine[i-1] <= signalLine[i-1] && macdLine[i] > signalLine[i]) {
                        signals.push(1);
                    } else if (macdLine[i-1] >= signalLine[i-1] && macdLine[i] < signalLine[i]) {
                        signals.push(-1);
                    } else {
                        signals.push(0);
                    }
                }
                return [0, ...signals];
            },
            
            adx_trend: (candles, params) => {
                const { adx, pdi, mdi } = ADX(candles, params.period);
                
                const signals = [];
                for (let i = 1; i < candles.length; i++) {
                    if (adx[i] === null || pdi[i] === null || mdi[i] === null ||
                        pdi[i-1] === null || mdi[i-1] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    // ADX > é–¾å€¼è¡¨ç¤ºè¶¨å‹¢å¼·å‹
                    if (adx[i] > params.threshold) {
                        // +DI ä¸Šç©¿ -DI è²·å…¥
                        if (pdi[i-1] <= mdi[i-1] && pdi[i] > mdi[i]) {
                            signals.push(1);
                        }
                        // +DI ä¸‹ç©¿ -DI è³£å‡º
                        else if (pdi[i-1] >= mdi[i-1] && pdi[i] < mdi[i]) {
                            signals.push(-1);
                        } else {
                            signals.push(0);
                        }
                    } else {
                        signals.push(0);
                    }
                }
                return [0, ...signals];
            },
            
            // === éœ‡ç›ªæŒ‡æ¨™ç­–ç•¥ ===
            
            rsi: (candles, params) => {
                const closes = candles.map(c => c.close);
                const rsi = RSI(closes, params.period);
                
                const signals = [];
                let lastSignal = 0;
                
                for (let i = 0; i < candles.length; i++) {
                    if (rsi[i] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    if (rsi[i] < params.oversold && lastSignal !== 1) {
                        signals.push(1);
                        lastSignal = 1;
                    } else if (rsi[i] > params.overbought && lastSignal !== -1) {
                        signals.push(-1);
                        lastSignal = -1;
                    } else {
                        signals.push(0);
                    }
                }
                return signals;
            },
            
            bollinger: (candles, params) => {
                const closes = candles.map(c => c.close);
                const { upper, lower } = BollingerBands(closes, params.period, params.std);
                
                const signals = [];
                let lastSignal = 0;
                
                for (let i = 0; i < candles.length; i++) {
                    if (upper[i] === null || lower[i] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    if (closes[i] <= lower[i] && lastSignal !== 1) {
                        signals.push(1);
                        lastSignal = 1;
                    } else if (closes[i] >= upper[i] && lastSignal !== -1) {
                        signals.push(-1);
                        lastSignal = -1;
                    } else {
                        signals.push(0);
                    }
                }
                return signals;
            },
            
            // === åƒ¹é‡è¤‡åˆç­–ç•¥ ===
            
            vwap: (candles, params) => {
                const vwap = VWAP(candles, params.period);
                const closes = candles.map(c => c.close);
                
                const signals = [];
                for (let i = 1; i < candles.length; i++) {
                    if (vwap[i] === null || vwap[i-1] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    // åƒ¹æ ¼ä¸Šç©¿ VWAP è²·å…¥
                    if (closes[i-1] <= vwap[i-1] && closes[i] > vwap[i]) {
                        signals.push(1);
                    }
                    // åƒ¹æ ¼ä¸‹ç©¿ VWAP è³£å‡º
                    else if (closes[i-1] >= vwap[i-1] && closes[i] < vwap[i]) {
                        signals.push(-1);
                    } else {
                        signals.push(0);
                    }
                }
                return [0, ...signals];
            },
            
            mfi: (candles, params) => {
                const mfi = MFI(candles, params.period);
                
                const signals = [];
                let lastSignal = 0;
                
                for (let i = 0; i < candles.length; i++) {
                    if (mfi[i] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    // MFI è¶…è³£è²·å…¥
                    if (mfi[i] < params.oversold && lastSignal !== 1) {
                        signals.push(1);
                        lastSignal = 1;
                    }
                    // MFI è¶…è²·è³£å‡º
                    else if (mfi[i] > params.overbought && lastSignal !== -1) {
                        signals.push(-1);
                        lastSignal = -1;
                    } else {
                        signals.push(0);
                    }
                }
                return signals;
            },
            
            obv: (candles, params) => {
                const obv = OBV(candles);
                const shortMA = SMA(obv, params.short);
                const longMA = SMA(obv, params.long);
                
                const signals = [];
                for (let i = 1; i < candles.length; i++) {
                    if (shortMA[i] === null || longMA[i] === null ||
                        shortMA[i-1] === null || longMA[i-1] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    // OBV çŸ­æœŸå‡ç·šä¸Šç©¿é•·æœŸå‡ç·š
                    if (shortMA[i-1] <= longMA[i-1] && shortMA[i] > longMA[i]) {
                        signals.push(1);
                    }
                    // OBV çŸ­æœŸå‡ç·šä¸‹ç©¿é•·æœŸå‡ç·š
                    else if (shortMA[i-1] >= longMA[i-1] && shortMA[i] < longMA[i]) {
                        signals.push(-1);
                    } else {
                        signals.push(0);
                    }
                }
                return [0, ...signals];
            },
            
            ad_line: (candles, params) => {
                const ad = ADLine(candles);
                const shortMA = SMA(ad, params.short);
                const longMA = SMA(ad, params.long);
                
                const signals = [];
                for (let i = 1; i < candles.length; i++) {
                    if (shortMA[i] === null || longMA[i] === null ||
                        shortMA[i-1] === null || longMA[i-1] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    if (shortMA[i-1] <= longMA[i-1] && shortMA[i] > longMA[i]) {
                        signals.push(1);
                    } else if (shortMA[i-1] >= longMA[i-1] && shortMA[i] < longMA[i]) {
                        signals.push(-1);
                    } else {
                        signals.push(0);
                    }
                }
                return [0, ...signals];
            },
            
            // === èƒŒé›¢ç­–ç•¥ ===
            
            rsi_divergence: (candles, params) => {
                const closes = candles.map(c => c.close);
                const rsi = RSI(closes, params.period);
                return detectDivergence(closes, rsi, params.lookback);
            },
            
            obv_divergence: (candles, params) => {
                const closes = candles.map(c => c.close);
                const obv = OBV(candles);
                return detectDivergence(closes, obv, params.lookback);
            },
            
            mfi_divergence: (candles, params) => {
                const closes = candles.map(c => c.close);
                const mfi = MFI(candles, params.period);
                return detectDivergence(closes, mfi, params.lookback);
            },
            
            // === è¤‡åˆç­–ç•¥ ===
            
            macd_rsi_combo: (candles, params) => {
                const closes = candles.map(c => c.close);
                const { macdLine, signalLine } = MACD(closes, 12, 26, 9);
                const rsi = RSI(closes, params.rsi_period);
                
                const signals = [];
                for (let i = 1; i < candles.length; i++) {
                    if (macdLine[i] === null || signalLine[i] === null || rsi[i] === null ||
                        macdLine[i-1] === null || signalLine[i-1] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    // MACD é»ƒé‡‘äº¤å‰ + RSI ä¸åœ¨è¶…è²·å€
                    if (macdLine[i-1] <= signalLine[i-1] && macdLine[i] > signalLine[i] && rsi[i] < params.rsi_high) {
                        signals.push(1);
                    }
                    // MACD æ­»äº¡äº¤å‰ + RSI ä¸åœ¨è¶…è³£å€
                    else if (macdLine[i-1] >= signalLine[i-1] && macdLine[i] < signalLine[i] && rsi[i] > params.rsi_low) {
                        signals.push(-1);
                    } else {
                        signals.push(0);
                    }
                }
                return [0, ...signals];
            },
            
            triple_screen: (candles, params) => {
                const closes = candles.map(c => c.close);
                const { macdLine, signalLine, histogram } = MACD(closes, 12, 26, 9);
                const rsi = RSI(closes, params.rsi_period);
                
                const signals = [];
                for (let i = 2; i < candles.length; i++) {
                    if (histogram[i] === null || histogram[i-1] === null || rsi[i] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    // ç¬¬ä¸€å±¤ï¼šMACD æŸ±ç‹€åœ–æ–¹å‘ï¼ˆé•·æœŸè¶¨å‹¢ï¼‰
                    const longTrend = histogram[i] > histogram[i-1] ? 1 : -1;
                    
                    // ç¬¬äºŒå±¤ï¼šRSI ç‹€æ…‹ï¼ˆä¸­æœŸéœ‡ç›ªï¼‰
                    const rsiSignal = rsi[i] < 30 ? 1 : (rsi[i] > 70 ? -1 : 0);
                    
                    // åªæœ‰ç•¶é•·æœŸè¶¨å‹¢å’Œä¸­æœŸéœ‡ç›ªä¸€è‡´æ™‚æ‰äº¤æ˜“
                    if (longTrend === 1 && rsiSignal === 1) {
                        signals.push(1);
                    } else if (longTrend === -1 && rsiSignal === -1) {
                        signals.push(-1);
                    } else {
                        signals.push(0);
                    }
                }
                return [0, 0, ...signals];
            },
            
            vwap_mfi_combo: (candles, params) => {
                const vwap = VWAP(candles, 20);
                const mfi = MFI(candles, params.mfi_period);
                const closes = candles.map(c => c.close);
                
                const signals = [];
                for (let i = 1; i < candles.length; i++) {
                    if (vwap[i] === null || mfi[i] === null) {
                        signals.push(0);
                        continue;
                    }
                    
                    // åƒ¹æ ¼åœ¨ VWAP ä¸Šæ–¹ + MFI ä¸Šå‡ä¸­ï¼ˆè³‡é‡‘æµå…¥ï¼‰
                    if (closes[i] > vwap[i] && mfi[i] > params.mfi_threshold && mfi[i-1] && mfi[i] > mfi[i-1]) {
                        signals.push(1);
                    }
                    // åƒ¹æ ¼åœ¨ VWAP ä¸‹æ–¹ + MFI ä¸‹é™ä¸­ï¼ˆè³‡é‡‘æµå‡ºï¼‰
                    else if (closes[i] < vwap[i] && mfi[i] < params.mfi_threshold && mfi[i-1] && mfi[i] < mfi[i-1]) {
                        signals.push(-1);
                    } else {
                        signals.push(0);
                    }
                }
                return [0, ...signals];
            },
            
            // === å®šæŠ•ç­–ç•¥ ===
            
            dca: (candles, params) => {
                const signals = [];
                const intervalBars = Math.floor(params.interval * 24);
                
                for (let i = 0; i < candles.length; i++) {
                    if (i % intervalBars === 0) {
                        signals.push(2); // ç‰¹æ®Šä¿¡è™Ÿï¼šå®šé¡è²·å…¥
                    } else {
                        signals.push(0);
                    }
                }
                return signals;
            },
            
            smart_dca: (candles, params) => {
                const closes = candles.map(c => c.close);
                const rsi = RSI(closes, 14);
                const intervalBars = Math.floor(params.interval * 24);
                
                const signals = [];
                for (let i = 0; i < candles.length; i++) {
                    if (i % intervalBars === 0) {
                        // æ ¹æ“š RSI èª¿æ•´è²·å…¥é‡‘é¡
                        if (rsi[i] !== null && rsi[i] < params.rsi_low) {
                            signals.push(3); // åŠ å€è²·å…¥
                        } else if (rsi[i] !== null && rsi[i] > params.rsi_high) {
                            signals.push(4); // æ¸›åŠè²·å…¥
                        } else {
                            signals.push(2); // æ­£å¸¸è²·å…¥
                        }
                    } else {
                        signals.push(0);
                    }
                }
                return signals;
            },
            
            // === Kç·šå½¢æ…‹ç­–ç•¥ ===
            
            // å°ç¨±ä¸‰è§’å½¢çªç ´ç­–ç•¥
            sym_triangle: (candles, params) => {
                const patterns = detectTrianglePatterns(candles, params.lookback, params.min_touches);
                return generateTriangleSignals(candles, patterns, 'symmetric', params);
            },
            
            // ä¸Šå‡ä¸‰è§’å½¢çªç ´ç­–ç•¥
            asc_triangle: (candles, params) => {
                const patterns = detectTrianglePatterns(candles, params.lookback, params.min_touches);
                return generateTriangleSignals(candles, patterns, 'ascending', params);
            },
            
            // ä¸‹é™ä¸‰è§’å½¢çªç ´ç­–ç•¥
            desc_triangle: (candles, params) => {
                const patterns = detectTrianglePatterns(candles, params.lookback, params.min_touches);
                return generateTriangleSignals(candles, patterns, 'descending', params);
            },
            
            // æ‰€æœ‰ä¸‰è§’å½¢å½¢æ…‹ç¶œåˆç­–ç•¥
            all_triangles: (candles, params) => {
                const patterns = detectTrianglePatterns(candles, params.lookback, params.min_touches);
                return generateTriangleSignals(candles, patterns, 'all', params);
            },
            
            // ä¸‰è§’å½¢ + RSI ç¢ºèªç­–ç•¥
            triangle_rsi: (candles, params) => {
                const patterns = detectTrianglePatterns(candles, params.lookback, params.min_touches);
                const closes = candles.map(c => c.close);
                const rsi = RSI(closes, 14);
                return generateTriangleSignalsWithConfirmation(candles, patterns, rsi, null, params);
            },
            
            // ä¸‰è§’å½¢ + MACD ç¢ºèªç­–ç•¥
            triangle_macd: (candles, params) => {
                const patterns = detectTrianglePatterns(candles, params.lookback, params.min_touches);
                const closes = candles.map(c => c.close);
                const macd = MACD(closes, 12, 26, 9);
                return generateTriangleSignalsWithConfirmation(candles, patterns, null, macd, params);
            },
            
            // ä¸‰è§’å½¢ + RSI + MACD å¤šé‡ç¢ºèªç­–ç•¥ï¼ˆæœ€é«˜å¯é åº¦ï¼‰
            triangle_multi: (candles, params) => {
                const patterns = detectTrianglePatterns(candles, params.lookback, params.min_touches);
                const closes = candles.map(c => c.close);
                const rsi = RSI(closes, 14);
                const macd = MACD(closes, 12, 26, 9);
                return generateTriangleSignalsWithConfirmation(candles, patterns, rsi, macd, params);
            }
        };
        
        // ==================== Kç·šä¸‰è§’å½¢æ…‹è­˜åˆ¥å‡½æ•¸ ====================
        
        // æ‰¾å‡ºå±€éƒ¨é«˜é»å’Œä½é»
        function findPivots(candles, leftBars, rightBars) {
            const highs = [];
            const lows = [];
            
            for (let i = leftBars; i < candles.length - rightBars; i++) {
                // æª¢æŸ¥æ˜¯å¦ç‚ºå±€éƒ¨é«˜é»
                let isHigh = true;
                for (let j = i - leftBars; j <= i + rightBars; j++) {
                    if (j !== i && candles[j].high >= candles[i].high) {
                        isHigh = false;
                        break;
                    }
                }
                if (isHigh) {
                    highs.push({ index: i, price: candles[i].high });
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºå±€éƒ¨ä½é»
                let isLow = true;
                for (let j = i - leftBars; j <= i + rightBars; j++) {
                    if (j !== i && candles[j].low <= candles[i].low) {
                        isLow = false;
                        break;
                    }
                }
                if (isLow) {
                    lows.push({ index: i, price: candles[i].low });
                }
            }
            
            return { highs, lows };
        }
        
        // ç·šæ€§å›æ­¸è¨ˆç®—è¶¨å‹¢ç·š
        function linearRegression(points) {
            if (points.length < 2) return null;
            
            const n = points.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            
            for (const p of points) {
                sumX += p.index;
                sumY += p.price;
                sumXY += p.index * p.price;
                sumX2 += p.index * p.index;
            }
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // è¨ˆç®— RÂ² å€¼ï¼ˆæ“¬åˆåº¦ï¼‰
            const meanY = sumY / n;
            let ssTot = 0, ssRes = 0;
            for (const p of points) {
                const predicted = slope * p.index + intercept;
                ssTot += Math.pow(p.price - meanY, 2);
                ssRes += Math.pow(p.price - predicted, 2);
            }
            const r2 = 1 - (ssRes / ssTot);
            
            return { slope, intercept, r2 };
        }
        
        // æª¢æ¸¬ä¸‰è§’å½¢å½¢æ…‹
        function detectTrianglePatterns(candles, lookback, minTouches) {
            const patterns = [];
            const pivotWindow = 3; // å±€éƒ¨æ¥µå€¼çš„æª¢æ¸¬çª—å£
            
            for (let endIdx = lookback; endIdx < candles.length; endIdx++) {
                const startIdx = endIdx - lookback;
                const windowCandles = candles.slice(startIdx, endIdx + 1);
                
                // æ‰¾å‡ºè©²çª—å£å…§çš„å±€éƒ¨é«˜ä½é»
                const { highs, lows } = findPivots(windowCandles, pivotWindow, pivotWindow);
                
                // éœ€è¦è¶³å¤ çš„è§¸é»
                if (highs.length < minTouches || lows.length < minTouches) continue;
                
                // è¨ˆç®—ä¸Šæ–¹è¶¨å‹¢ç·šï¼ˆé€£æ¥é«˜é»ï¼‰
                const upperLine = linearRegression(highs);
                // è¨ˆç®—ä¸‹æ–¹è¶¨å‹¢ç·šï¼ˆé€£æ¥ä½é»ï¼‰
                const lowerLine = linearRegression(lows);
                
                if (!upperLine || !lowerLine) continue;
                
                // æ“¬åˆåº¦è¦æ±‚
                if (upperLine.r2 < 0.7 || lowerLine.r2 < 0.7) continue;
                
                // è¨ˆç®—æ–œç‡é–¾å€¼ï¼ˆç›¸å°æ–¼åƒ¹æ ¼çš„ç™¾åˆ†æ¯”ï¼‰
                const avgPrice = windowCandles.reduce((s, c) => s + c.close, 0) / windowCandles.length;
                const slopeThreshold = avgPrice * 0.0001; // æ¥è¿‘æ°´å¹³çš„é–¾å€¼
                
                // åˆ¤æ–·ä¸‰è§’å½¢é¡å‹
                let triangleType = null;
                
                const upperSlope = upperLine.slope;
                const lowerSlope = lowerLine.slope;
                
                // ç¢ºä¿æ˜¯æ”¶æ–‚å½¢æ…‹ï¼ˆå…©ç·šæœƒç›¸äº¤ï¼‰
                if (upperSlope >= lowerSlope) continue; // ä¸æ”¶æ–‚
                
                // å°ç¨±ä¸‰è§’å½¢ï¼šä¸Šæ–¹ä¸‹é™ï¼Œä¸‹æ–¹ä¸Šå‡
                if (upperSlope < -slopeThreshold && lowerSlope > slopeThreshold) {
                    triangleType = 'symmetric';
                }
                // ä¸Šå‡ä¸‰è§’å½¢ï¼šä¸Šæ–¹æ¥è¿‘æ°´å¹³ï¼Œä¸‹æ–¹ä¸Šå‡
                else if (Math.abs(upperSlope) < slopeThreshold * 3 && lowerSlope > slopeThreshold) {
                    triangleType = 'ascending';
                }
                // ä¸‹é™ä¸‰è§’å½¢ï¼šä¸Šæ–¹ä¸‹é™ï¼Œä¸‹æ–¹æ¥è¿‘æ°´å¹³
                else if (upperSlope < -slopeThreshold && Math.abs(lowerSlope) < slopeThreshold * 3) {
                    triangleType = 'descending';
                }
                
                if (triangleType) {
                    // è¨ˆç®—å½¢æ…‹çš„å‚ç›´é«˜åº¦ï¼ˆç”¨æ–¼ç›®æ¨™åƒ¹ï¼‰
                    const patternHigh = Math.max(...windowCandles.map(c => c.high));
                    const patternLow = Math.min(...windowCandles.map(c => c.low));
                    const height = patternHigh - patternLow;
                    
                    // è¨ˆç®—äº¤æ˜“é‡è®ŠåŒ–ï¼ˆå½¢æ…‹æœŸé–“æ‡‰è©²ç¸®æ¸›ï¼‰
                    const firstHalfVol = windowCandles.slice(0, Math.floor(lookback/2)).reduce((s, c) => s + c.volume, 0);
                    const secondHalfVol = windowCandles.slice(Math.floor(lookback/2)).reduce((s, c) => s + c.volume, 0);
                    const volumeDecreasing = secondHalfVol < firstHalfVol;
                    
                    patterns.push({
                        type: triangleType,
                        startIndex: startIdx,
                        endIndex: endIdx,
                        upperLine,
                        lowerLine,
                        height,
                        patternHigh,
                        patternLow,
                        volumeDecreasing,
                        avgPrice
                    });
                }
            }
            
            return patterns;
        }
        
        // ç”Ÿæˆä¸‰è§’å½¢çªç ´ä¿¡è™Ÿ
        function generateTriangleSignals(candles, patterns, filterType, params) {
            const signals = new Array(candles.length).fill(0);
            const volumes = candles.map(c => c.volume);
            const avgVolume = SMA(volumes, 20);
            
            for (const pattern of patterns) {
                if (filterType !== 'all' && pattern.type !== filterType) continue;
                
                const breakoutIdx = pattern.endIndex + 1;
                if (breakoutIdx >= candles.length) continue;
                
                const candle = candles[breakoutIdx];
                const prevCandle = candles[pattern.endIndex];
                
                // è¨ˆç®—çªç ´é»çš„è¶¨å‹¢ç·šåƒ¹æ ¼
                const upperPrice = pattern.upperLine.slope * (breakoutIdx - pattern.startIndex) + pattern.upperLine.intercept;
                const lowerPrice = pattern.lowerLine.slope * (breakoutIdx - pattern.startIndex) + pattern.lowerLine.intercept;
                
                // ç¢ºèªçªç ´ï¼ˆæ”¶ç›¤åƒ¹çªç ´ï¼‰
                const breakoutUp = candle.close > upperPrice && prevCandle.close <= upperPrice;
                const breakoutDown = candle.close < lowerPrice && prevCandle.close >= lowerPrice;
                
                // äº¤æ˜“é‡ç¢ºèªï¼ˆçªç ´æ™‚æˆäº¤é‡æ”¾å¤§ï¼‰
                const volumeConfirm = !params.volume_confirm || 
                    (avgVolume[breakoutIdx] && candle.volume > avgVolume[breakoutIdx] * 1.5);
                
                if (!volumeConfirm) continue;
                
                // æ ¹æ“šå½¢æ…‹é¡å‹å’Œçªç ´æ–¹å‘ç”Ÿæˆä¿¡è™Ÿ
                if (breakoutUp) {
                    // ä¸Šå‡ä¸‰è§’å½¢å‘ä¸Šçªç ´ï¼ˆæœ€é«˜å¯é åº¦ï¼‰
                    // å°ç¨±ä¸‰è§’å½¢å‘ä¸Šçªç ´ï¼ˆä¸­ç­‰å¯é åº¦ï¼‰
                    // ä¸‹é™ä¸‰è§’å½¢å‘ä¸Šçªç ´ï¼ˆåè½‰ä¿¡è™Ÿï¼Œè¼ƒä½å¯é åº¦ï¼‰
                    if (pattern.type === 'ascending' || pattern.type === 'symmetric') {
                        signals[breakoutIdx] = 1;
                    }
                }
                
                if (breakoutDown) {
                    // ä¸‹é™ä¸‰è§’å½¢å‘ä¸‹çªç ´ï¼ˆæœ€é«˜å¯é åº¦ï¼‰
                    // å°ç¨±ä¸‰è§’å½¢å‘ä¸‹çªç ´ï¼ˆä¸­ç­‰å¯é åº¦ï¼‰
                    // ä¸Šå‡ä¸‰è§’å½¢å‘ä¸‹çªç ´ï¼ˆå¤±æ•—å½¢æ…‹ï¼Œè¼ƒä½å¯é åº¦ï¼‰
                    if (pattern.type === 'descending' || pattern.type === 'symmetric') {
                        signals[breakoutIdx] = -1;
                    }
                }
            }
            
            return signals;
        }
        
        // ç”Ÿæˆå¸¶æŒ‡æ¨™ç¢ºèªçš„ä¸‰è§’å½¢ä¿¡è™Ÿ
        function generateTriangleSignalsWithConfirmation(candles, patterns, rsi, macd, params) {
            const signals = new Array(candles.length).fill(0);
            const volumes = candles.map(c => c.volume);
            const avgVolume = SMA(volumes, 20);
            
            for (const pattern of patterns) {
                const breakoutIdx = pattern.endIndex + 1;
                if (breakoutIdx >= candles.length) continue;
                
                const candle = candles[breakoutIdx];
                const prevCandle = candles[pattern.endIndex];
                
                // è¨ˆç®—è¶¨å‹¢ç·šåƒ¹æ ¼
                const upperPrice = pattern.upperLine.slope * (breakoutIdx - pattern.startIndex) + pattern.upperLine.intercept;
                const lowerPrice = pattern.lowerLine.slope * (breakoutIdx - pattern.startIndex) + pattern.lowerLine.intercept;
                
                const breakoutUp = candle.close > upperPrice && prevCandle.close <= upperPrice;
                const breakoutDown = candle.close < lowerPrice && prevCandle.close >= lowerPrice;
                
                // äº¤æ˜“é‡ç¢ºèª
                const volumeConfirm = avgVolume[breakoutIdx] && candle.volume > avgVolume[breakoutIdx] * 1.3;
                
                // RSI ç¢ºèª
                let rsiConfirmUp = true, rsiConfirmDown = true;
                if (rsi) {
                    const rsiVal = rsi[breakoutIdx];
                    const prevRsi = rsi[breakoutIdx - 1];
                    if (rsiVal !== null && prevRsi !== null) {
                        // å‘ä¸Šçªç ´ï¼šRSI æ‡‰ä¸Šå‡ä¸”çªç ´ 50 ä¸­ç·š
                        rsiConfirmUp = rsiVal > 50 && rsiVal > prevRsi;
                        // å‘ä¸‹çªç ´ï¼šRSI æ‡‰ä¸‹é™ä¸”è·Œç ´ 50 ä¸­ç·š
                        rsiConfirmDown = rsiVal < 50 && rsiVal < prevRsi;
                    }
                }
                
                // MACD ç¢ºèª
                let macdConfirmUp = true, macdConfirmDown = true;
                if (macd) {
                    const macdVal = macd.macdLine[breakoutIdx];
                    const signalVal = macd.signalLine[breakoutIdx];
                    const prevMacd = macd.macdLine[breakoutIdx - 1];
                    const prevSignal = macd.signalLine[breakoutIdx - 1];
                    
                    if (macdVal !== null && signalVal !== null && prevMacd !== null && prevSignal !== null) {
                        // å‘ä¸Šçªç ´ï¼šMACD é»ƒé‡‘äº¤å‰æˆ– MACD > Signal
                        macdConfirmUp = macdVal > signalVal || (prevMacd <= prevSignal && macdVal > signalVal);
                        // å‘ä¸‹çªç ´ï¼šMACD æ­»äº¡äº¤å‰æˆ– MACD < Signal
                        macdConfirmDown = macdVal < signalVal || (prevMacd >= prevSignal && macdVal < signalVal);
                    }
                }
                
                // ç¶œåˆåˆ¤æ–·
                if (breakoutUp && volumeConfirm && rsiConfirmUp && macdConfirmUp) {
                    if (pattern.type === 'ascending' || pattern.type === 'symmetric') {
                        signals[breakoutIdx] = 1;
                    }
                }
                
                if (breakoutDown && volumeConfirm && rsiConfirmDown && macdConfirmDown) {
                    if (pattern.type === 'descending' || pattern.type === 'symmetric') {
                        signals[breakoutIdx] = -1;
                    }
                }
            }
            
            return signals;
        }
        
        // ==================== å›æ¸¬å¼•æ“ ====================
        
        function runBacktest(candles, signals, config) {
            const { capital, feeRate, strategy, dcaAmount } = config;
            
            let cash = capital;
            let position = 0;
            let equity = capital;
            let entryPrice = 0;
            
            const trades = [];
            const equityCurve = [{ time: candles[0].time, equity: capital }];
            
            let peakEquity = capital;
            let maxDrawdown = 0;
            let wins = 0;
            let losses = 0;
            let totalProfit = 0;
            let totalLoss = 0;
            
            for (let i = 0; i < candles.length; i++) {
                const price = candles[i].close;
                const time = candles[i].time;
                const signal = signals[i];
                
                // DCA å’Œæ™ºèƒ½ DCA ç­–ç•¥ç‰¹æ®Šè™•ç†
                if ((strategy === 'dca' || strategy === 'smart_dca') && signal >= 2) {
                    let amount = dcaAmount;
                    
                    // æ™ºèƒ½ DCAï¼šæ ¹æ“šä¿¡è™Ÿèª¿æ•´é‡‘é¡
                    if (signal === 3) amount = dcaAmount * 2;  // åŠ å€
                    if (signal === 4) amount = dcaAmount * 0.5; // æ¸›åŠ
                    
                    amount = Math.min(amount, cash);
                    if (amount > 10) {
                        const fee = amount * feeRate / 100;
                        const qty = (amount - fee) / price;
                        position += qty;
                        cash -= amount;
                        
                        trades.push({
                            time,
                            type: 'buy',
                            price,
                            qty,
                            pnl: null,
                            equity: cash + position * price
                        });
                    }
                }
                // ä¸€èˆ¬ç­–ç•¥
                else if (signal === 1 && position === 0) {
                    // è²·å…¥
                    const fee = cash * feeRate / 100;
                    const qty = (cash - fee) / price;
                    position = qty;
                    entryPrice = price;
                    cash = 0;
                    
                    trades.push({
                        time,
                        type: 'buy',
                        price,
                        qty,
                        pnl: null,
                        equity: position * price
                    });
                }
                else if (signal === -1 && position > 0) {
                    // è³£å‡º
                    const revenue = position * price;
                    const fee = revenue * feeRate / 100;
                    const pnl = revenue - fee - (position * entryPrice);
                    const pnlPercent = (price - entryPrice) / entryPrice * 100;
                    
                    cash = revenue - fee;
                    
                    trades.push({
                        time,
                        type: 'sell',
                        price,
                        qty: position,
                        pnl,
                        pnlPercent,
                        equity: cash
                    });
                    
                    if (pnl > 0) {
                        wins++;
                        totalProfit += pnl;
                    } else {
                        losses++;
                        totalLoss += Math.abs(pnl);
                    }
                    
                    position = 0;
                    entryPrice = 0;
                }
                
                // æ›´æ–°æ¬Šç›Š
                equity = cash + position * price;
                equityCurve.push({ time, equity });
                
                // è¨ˆç®—æœ€å¤§å›æ’¤
                if (equity > peakEquity) {
                    peakEquity = equity;
                }
                const drawdown = (peakEquity - equity) / peakEquity * 100;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
            }
            
            // æœ€çµ‚å¼·åˆ¶å¹³å€‰
            const finalPrice = candles[candles.length - 1].close;
            if (position > 0) {
                const revenue = position * finalPrice;
                const fee = revenue * feeRate / 100;
                cash = revenue - fee;
                equity = cash;
            }
            
            // è¨ˆç®—çµ±è¨ˆ
            const totalReturn = ((equity - capital) / capital) * 100;
            const days = (candles[candles.length - 1].time - candles[0].time) / (1000 * 60 * 60 * 24);
            const annualReturn = (Math.pow(equity / capital, 365 / days) - 1) * 100;
            
            // å¤æ™®æ¯”ç‡ï¼ˆç°¡åŒ–è¨ˆç®—ï¼‰
            const returns = [];
            for (let i = 1; i < equityCurve.length; i++) {
                returns.push((equityCurve[i].equity - equityCurve[i-1].equity) / equityCurve[i-1].equity);
            }
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const stdReturn = Math.sqrt(returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / returns.length);
            const sharpeRatio = stdReturn > 0 ? (avgReturn / stdReturn) * Math.sqrt(365) : 0;
            
            const totalTrades = trades.filter(t => t.type === 'sell').length;
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const profitFactor = totalLoss > 0 ? totalProfit / totalLoss : totalProfit > 0 ? Infinity : 0;
            
            return {
                trades,
                equityCurve,
                stats: {
                    totalReturn,
                    annualReturn,
                    maxDrawdown,
                    sharpeRatio,
                    winRate,
                    totalTrades,
                    profitFactor,
                    finalEquity: equity
                }
            };
        }
        
        // ==================== UI æ§åˆ¶ ====================
        
        let equityChart = null;
        let selectedStrategy = 'sma_cross';
        
        // ç­–ç•¥å¡ç‰‡é¸æ“‡
        document.querySelectorAll('.strategy-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.strategy-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                selectedStrategy = card.dataset.strategy;
            });
        });
        
        // å–å¾—ç­–ç•¥åƒæ•¸
        function getStrategyParams() {
            switch (selectedStrategy) {
                // è¶¨å‹¢è·Ÿéš¨ç­–ç•¥
                case 'sma_cross':
                    return {
                        short: parseInt(document.getElementById('sma_short').value),
                        long: parseInt(document.getElementById('sma_long').value)
                    };
                case 'ema_cross':
                    return {
                        short: parseInt(document.getElementById('ema_short').value),
                        long: parseInt(document.getElementById('ema_long').value)
                    };
                case 'macd':
                    return {
                        fast: parseInt(document.getElementById('macd_fast').value),
                        slow: parseInt(document.getElementById('macd_slow').value),
                        signal: parseInt(document.getElementById('macd_signal').value)
                    };
                case 'adx_trend':
                    return {
                        period: parseInt(document.getElementById('adx_period').value),
                        threshold: parseInt(document.getElementById('adx_threshold').value)
                    };
                    
                // éœ‡ç›ªæŒ‡æ¨™ç­–ç•¥
                case 'rsi':
                    return {
                        period: parseInt(document.getElementById('rsi_period').value),
                        oversold: parseInt(document.getElementById('rsi_oversold').value),
                        overbought: parseInt(document.getElementById('rsi_overbought').value)
                    };
                case 'bollinger':
                    return {
                        period: parseInt(document.getElementById('bb_period').value),
                        std: parseFloat(document.getElementById('bb_std').value)
                    };
                    
                // åƒ¹é‡è¤‡åˆç­–ç•¥
                case 'vwap':
                    return {
                        period: parseInt(document.getElementById('vwap_period').value)
                    };
                case 'mfi':
                    return {
                        period: parseInt(document.getElementById('mfi_period').value),
                        oversold: parseInt(document.getElementById('mfi_oversold').value),
                        overbought: parseInt(document.getElementById('mfi_overbought').value)
                    };
                case 'obv':
                    return {
                        short: parseInt(document.getElementById('obv_short').value),
                        long: parseInt(document.getElementById('obv_long').value)
                    };
                case 'ad_line':
                    return {
                        short: parseInt(document.getElementById('ad_short').value),
                        long: parseInt(document.getElementById('ad_long').value)
                    };
                    
                // èƒŒé›¢ç­–ç•¥
                case 'rsi_divergence':
                    return {
                        period: parseInt(document.getElementById('rsi_div_period').value),
                        lookback: parseInt(document.getElementById('rsi_div_lookback').value)
                    };
                case 'obv_divergence':
                    return {
                        lookback: parseInt(document.getElementById('obv_div_lookback').value)
                    };
                case 'mfi_divergence':
                    return {
                        period: parseInt(document.getElementById('mfi_div_period').value),
                        lookback: parseInt(document.getElementById('mfi_div_lookback').value)
                    };
                    
                // è¤‡åˆç­–ç•¥
                case 'macd_rsi_combo':
                    return {
                        rsi_period: parseInt(document.getElementById('combo_rsi_period').value),
                        rsi_low: parseInt(document.getElementById('combo_rsi_low').value),
                        rsi_high: parseInt(document.getElementById('combo_rsi_high').value)
                    };
                case 'triple_screen':
                    return {
                        rsi_period: parseInt(document.getElementById('ts_rsi_period').value)
                    };
                case 'vwap_mfi_combo':
                    return {
                        mfi_period: parseInt(document.getElementById('vwap_mfi_period').value),
                        mfi_threshold: parseInt(document.getElementById('vwap_mfi_threshold').value)
                    };
                    
                // å®šæŠ•ç­–ç•¥
                case 'dca':
                    return {
                        interval: parseInt(document.getElementById('dca_interval').value),
                        amount: parseFloat(document.getElementById('dca_amount').value)
                    };
                case 'smart_dca':
                    return {
                        interval: parseInt(document.getElementById('sdca_interval').value),
                        amount: parseFloat(document.getElementById('sdca_base').value),
                        rsi_low: parseInt(document.getElementById('sdca_rsi_low').value),
                        rsi_high: parseInt(document.getElementById('sdca_rsi_high').value)
                    };
                    
                // Kç·šä¸‰è§’å½¢æ…‹ç­–ç•¥
                case 'sym_triangle':
                    return {
                        lookback: parseInt(document.getElementById('sym_lookback').value),
                        min_touches: parseInt(document.getElementById('sym_touches').value),
                        volume_confirm: document.getElementById('sym_vol_confirm').checked
                    };
                case 'asc_triangle':
                    return {
                        lookback: parseInt(document.getElementById('asc_lookback').value),
                        min_touches: parseInt(document.getElementById('asc_touches').value),
                        volume_confirm: document.getElementById('asc_vol_confirm').checked
                    };
                case 'desc_triangle':
                    return {
                        lookback: parseInt(document.getElementById('desc_lookback').value),
                        min_touches: parseInt(document.getElementById('desc_touches').value),
                        volume_confirm: document.getElementById('desc_vol_confirm').checked
                    };
                case 'all_triangles':
                    return {
                        lookback: parseInt(document.getElementById('all_lookback').value),
                        min_touches: parseInt(document.getElementById('all_touches').value),
                        volume_confirm: document.getElementById('all_vol_confirm').checked
                    };
                case 'triangle_rsi':
                    return {
                        lookback: parseInt(document.getElementById('tri_rsi_lookback').value),
                        min_touches: parseInt(document.getElementById('tri_rsi_touches').value),
                        volume_confirm: true
                    };
                case 'triangle_macd':
                    return {
                        lookback: parseInt(document.getElementById('tri_macd_lookback').value),
                        min_touches: parseInt(document.getElementById('tri_macd_touches').value),
                        volume_confirm: true
                    };
                case 'triangle_multi':
                    return {
                        lookback: parseInt(document.getElementById('tri_multi_lookback').value),
                        min_touches: parseInt(document.getElementById('tri_multi_touches').value),
                        volume_confirm: true
                    };
                    
                default:
                    return {};
            }
        }
        
        // å¾å¹£å®‰å–å¾— K ç·šæ•¸æ“šï¼ˆæ”¯æ´é•·æœŸæ­·å²æ•¸æ“šåˆ†æ‰¹è«‹æ±‚ï¼‰
        async function fetchKlines(symbol, interval, startTimeValue) {
            const endTime = Date.now();
            let startTime;
            
            // åˆ¤æ–·æ˜¯å¹´ä»½é‚„æ˜¯å¤©æ•¸
            if (startTimeValue >= 2017 && startTimeValue <= 2030) {
                // å¹´ä»½æ¨¡å¼
                startTime = new Date(`${startTimeValue}-01-01T00:00:00Z`).getTime();
            } else {
                // å¤©æ•¸æ¨¡å¼
                startTime = endTime - startTimeValue * 24 * 60 * 60 * 1000;
            }
            
            const allCandles = [];
            let currentStartTime = startTime;
            const limit = 1000; // å¹£å®‰ API å–®æ¬¡æœ€å¤š 1000 æ ¹
            
            // è¨ˆç®—æ¯æ ¹ K ç·šçš„æ™‚é–“é–“éš”ï¼ˆæ¯«ç§’ï¼‰
            const intervalMs = {
                '1h': 60 * 60 * 1000,
                '4h': 4 * 60 * 60 * 1000,
                '1d': 24 * 60 * 60 * 1000,
                '1w': 7 * 24 * 60 * 60 * 1000
            }[interval];
            
            // é ä¼°éœ€è¦è«‹æ±‚çš„æ¬¡æ•¸
            const totalBars = Math.ceil((endTime - startTime) / intervalMs);
            const totalRequests = Math.ceil(totalBars / limit);
            let currentRequest = 0;
            
            console.log(`é è¨ˆéœ€è¦ ${totalRequests} æ¬¡è«‹æ±‚ï¼Œå…±ç´„ ${totalBars} æ ¹ K ç·š`);
            
            while (currentStartTime < endTime) {
                const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&startTime=${currentStartTime}&endTime=${endTime}&limit=${limit}`;
                
                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`API éŒ¯èª¤: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.length === 0) break;
                    
                    const candles = data.map(k => ({
                        time: k[0],
                        open: parseFloat(k[1]),
                        high: parseFloat(k[2]),
                        low: parseFloat(k[3]),
                        close: parseFloat(k[4]),
                        volume: parseFloat(k[5])
                    }));
                    
                    allCandles.push(...candles);
                    
                    // æ›´æ–°é€²åº¦
                    currentRequest++;
                    const progress = Math.min(30 + (currentRequest / totalRequests) * 30, 60);
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('loadingText').textContent = 
                        `æ­£åœ¨è¼‰å…¥æ•¸æ“š... ${allCandles.length} æ ¹ K ç·š (${currentRequest}/${totalRequests})`;
                    
                    // ä¸‹ä¸€æ¬¡è«‹æ±‚çš„èµ·å§‹æ™‚é–“
                    currentStartTime = data[data.length - 1][0] + intervalMs;
                    
                    // å¦‚æœè¿”å›çš„æ•¸æ“šå°‘æ–¼ limitï¼Œè¡¨ç¤ºå·²ç¶“åˆ°æœ€æ–°äº†
                    if (data.length < limit) break;
                    
                    // é¿å…è«‹æ±‚éå¿«è¢«é™åˆ¶
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.error('è«‹æ±‚å¤±æ•—:', error);
                    throw error;
                }
            }
            
            console.log(`å…±å–å¾— ${allCandles.length} æ ¹ K ç·š`);
            return allCandles;
        }
        
        // æ›´æ–°åœ–è¡¨ï¼ˆåŠ å…¥è²·å…¥æŒæœ‰å°æ¯”ï¼‰
        function updateChart(equityCurve, candles) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            if (equityChart) {
                equityChart.destroy();
            }
            
            // è¨ˆç®—è²·å…¥æŒæœ‰çš„æ¬Šç›Šæ›²ç·š
            const initialCapital = equityCurve[0].equity;
            const initialPrice = candles[0].close;
            const holdingQty = initialCapital / initialPrice;
            
            const buyHoldCurve = candles.map(c => ({
                time: c.time,
                equity: holdingQty * c.close
            }));
            
            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: equityCurve.map(d => new Date(d.time)),
                    datasets: [
                        {
                            label: 'ç­–ç•¥æ¬Šç›Š',
                            data: equityCurve.map(d => d.equity),
                            borderColor: '#f0b90b',
                            backgroundColor: 'rgba(240, 185, 11, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'è²·å…¥æŒæœ‰',
                            data: buyHoldCurve.map(d => d.equity),
                            borderColor: '#8a8a9a',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            borderWidth: 1.5,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#8a8a9a' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.raw.toLocaleString(undefined, {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#8a8a9a', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#8a8a9a',
                                callback: v => '$' + v.toLocaleString()
                            }
                        }
                    }
                }
            });
        }
        
        // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
        function updateStats(stats, candles) {
            const setValueWithColor = (id, value, isPercent = true) => {
                const el = document.getElementById(id);
                el.textContent = isPercent ? value.toFixed(2) + '%' : value.toFixed(2);
                el.classList.remove('profit', 'loss');
                if (value > 0) el.classList.add('profit');
                else if (value < 0) el.classList.add('loss');
            };
            
            // å›æ¸¬æœŸé–“
            const startDate = new Date(candles[0].time).toLocaleDateString('zh-TW');
            const endDate = new Date(candles[candles.length - 1].time).toLocaleDateString('zh-TW');
            document.getElementById('backtestPeriod').textContent = `${startDate} ~ ${endDate}`;
            document.getElementById('totalBars').textContent = candles.length.toLocaleString();
            
            // è¨ˆç®—è²·å…¥æŒæœ‰å ±é…¬
            const buyHoldReturn = ((candles[candles.length - 1].close - candles[0].close) / candles[0].close) * 100;
            setValueWithColor('buyHoldReturn', buyHoldReturn);
            
            // ç­–ç•¥ vs è²·å…¥æŒæœ‰
            const strategyVsHold = stats.totalReturn - buyHoldReturn;
            setValueWithColor('strategyVsHold', strategyVsHold);
            
            setValueWithColor('totalReturn', stats.totalReturn);
            setValueWithColor('annualReturn', stats.annualReturn);
            setValueWithColor('maxDrawdown', -stats.maxDrawdown);
            document.getElementById('sharpeRatio').textContent = stats.sharpeRatio.toFixed(2);
            document.getElementById('winRate').textContent = stats.winRate.toFixed(1) + '%';
            document.getElementById('totalTrades').textContent = stats.totalTrades;
            document.getElementById('profitFactor').textContent = 
                stats.profitFactor === Infinity ? 'âˆ' : stats.profitFactor.toFixed(2);
            document.getElementById('finalEquity').textContent = '$' + stats.finalEquity.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // æ›´æ–°äº¤æ˜“ç´€éŒ„
        function updateTrades(trades) {
            const tbody = document.getElementById('tradesBody');
            tbody.innerHTML = '';
            
            trades.slice().reverse().forEach(trade => {
                const row = document.createElement('tr');
                const time = new Date(trade.time).toLocaleString('zh-TW');
                const pnlDisplay = trade.pnl !== null 
                    ? `<span style="color: ${trade.pnl >= 0 ? 'var(--profit)' : 'var(--loss)'}">
                         ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}
                       </span>`
                    : '-';
                
                row.innerHTML = `
                    <td>${time}</td>
                    <td><span class="tag ${trade.type}">${trade.type === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}</span></td>
                    <td>$${trade.price.toFixed(4)}</td>
                    <td>${trade.qty.toFixed(6)}</td>
                    <td>${pnlDisplay}</td>
                    <td>$${trade.equity.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // åŸ·è¡Œå›æ¸¬
        document.getElementById('runBacktest').addEventListener('click', async () => {
            const btn = document.getElementById('runBacktest');
            const loading = document.getElementById('loading');
            const results = document.getElementById('resultsContainer');
            const welcome = document.getElementById('welcomePanel');
            const progressFill = document.getElementById('progressFill');
            
            btn.disabled = true;
            loading.classList.add('active');
            results.classList.add('hidden');
            welcome.classList.add('hidden');
            progressFill.style.width = '10%';
            
            try {
                const symbol = document.getElementById('symbol').value;
                const interval = document.getElementById('interval').value;
                const startTimeValue = parseInt(document.getElementById('startTime').value);
                const capital = parseFloat(document.getElementById('capital').value);
                const feeRate = parseFloat(document.getElementById('fee').value);
                
                progressFill.style.width = '30%';
                document.getElementById('loadingText').textContent = 'æ­£åœ¨é€£æ¥å¹£å®‰ API...';
                
                // å–å¾—æ•¸æ“š
                const candles = await fetchKlines(symbol, interval, startTimeValue);
                progressFill.style.width = '60%';
                document.getElementById('loadingText').textContent = `æ­£åœ¨è¨ˆç®—ç­–ç•¥ä¿¡è™Ÿ... (${candles.length} æ ¹ K ç·š)`;
                
                // ç”Ÿæˆä¿¡è™Ÿ
                const params = getStrategyParams();
                const signals = strategies[selectedStrategy](candles, params);
                progressFill.style.width = '80%';
                document.getElementById('loadingText').textContent = 'æ­£åœ¨åŸ·è¡Œå›æ¸¬è¨ˆç®—...';
                
                // åŸ·è¡Œå›æ¸¬
                const config = {
                    capital,
                    feeRate,
                    strategy: selectedStrategy,
                    dcaAmount: params.amount || 0
                };
                
                const result = runBacktest(candles, signals, config);
                progressFill.style.width = '100%';
                
                // æ›´æ–° UI
                setTimeout(() => {
                    updateStats(result.stats, candles);
                    updateChart(result.equityCurve, candles);
                    updateTrades(result.trades);
                    
                    loading.classList.remove('active');
                    results.classList.remove('hidden');
                    btn.disabled = false;
                    progressFill.style.width = '0%';
                }, 300);
                
            } catch (error) {
                console.error('å›æ¸¬éŒ¯èª¤:', error);
                alert('å›æ¸¬åŸ·è¡Œå¤±æ•—ï¼š' + error.message);
                loading.classList.remove('active');
                welcome.classList.remove('hidden');
                btn.disabled = false;
                progressFill.style.width = '0%';
            }
        });
    </script>
</body>
</html>